{% extends 'base.html' %}
{% block title %}Hacker Brunch{% endblock %}

{% block content %}

<div class="container">
  <div class="row">
  <table class="table table-striped myTable">
    <thead>
      <tr>
        <th><button type="button" class="btn btn-default btn-xs glyphicon glyphicon-filter align-right"></button>  Date</th>
        <th>Name</th>
        <th>People</th>
        <th>Available Reservation Times</th><!-- filter to toggle fields -->
      </tr>

      <tr class="search-fields" display="none">
        <!-- Filters for selecting from table -->
        <th>
          <select id="myDate" class="form-control" onchange="myFilter()">
            <option></option>
            {% for date in dates %}
            <option>{{ date[0].strftime('%b %-d, %a') }}</option>
            {% endfor %}
          </select>
        </th>

        <th>
            <input id="myResto" type="text" class="form-control" onkeyup="myFilter()">
        </th>
        
        <th>
          <select id="myNum" onchange="myFilter()" class="form-control">
            <option></option>
            <option>2</option>
            <option>4</option>
            <option>6</option>
          </select>
        </th>

        <th></tr>

    </thead>
    <tbody>
      {% for reservation in reservations %}
      <tr class='reservation-entry'>
        <td>{{ reservation.date.strftime('%b %-d, %a') }}</td>
        <td><a href='/restaurant_details/{{ reservation.opentable.restaurants[0].restaurant_id }}'>{{ reservation.opentable.name }}</a></td>
        <td>{{ reservation.people }}</td>
        <td>
        <!-- clean up time string for looping over -->
        {% set timeline = reservation.time|replace('{','') %}
        {% set timeline = timeline|replace('}','') %}
        {% set timeline = timeline.split(',') %}
        {% for time in timeline %}
          <!-- make unique opentable URL depending on available time -->
          {% if (time[0:1] == '9') %}
          <a href='http://opentable.com/opentables.aspx?t=rest&r={{ reservation.opentable_id }}&d={{ reservation.date.strftime('%m/%d/%Y') }}%200{{ time }}:00%20AM&p={{ reservation.people }}' target='_blank'
          <button type="button" class="btn btn-primary btn-xs">{{ time }} AM</button></a>
          {% elif (time[0:2] == '10') or (time[0:2] == '11') %}
          <a href='http://opentable.com/opentables.aspx?t=rest&r={{ reservation.opentable_id }}&d={{ reservation.date.strftime('%m/%d/%Y') }}%20{{ time }}:00%20AM&p={{ reservation.people }}' target='_blank'
          <button type="button" class="btn btn-primary btn-xs">{{ time }} AM</button></a>
          {% elif (time[0:2] == '12') %}
          <a href='http://opentable.com/opentables.aspx?t=rest&r={{ reservation.opentable_id }}&d={{ reservation.date.strftime('%m/%d/%Y') }}%20{{ time }}:00%20PM&p={{ reservation.people }}' target='_blank'
          <button type="button" class="btn btn-primary btn-xs">{{ time }} PM</button></a>
          {% else %}
          <a href='http://opentable.com/opentables.aspx?t=rest&r={{ reservation.opentable_id }}&d={{ reservation.date.strftime('%m/%d/%Y') }}%200{{ time }}:00%20PM&p={{ reservation.people }}' target='_blank'
          <button type="button" class="btn btn-primary btn-xs">{{ time }} PM</button></a>
          {% endif %}
        {% endfor %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
</div>

<div class="container" style="height: 80%">
  <button id='populate_map' type="button" class="btn btn-primary btn-xs">POPULATE MAP</button>
  <button id='reset_map' type="button" class="btn btn-primary btn-xs">RESET MAP</button>
  <div id="homepage-map" style="height: 80%"></div>
</div>

<script type="text/javascript">

'use strict';

// DataTable JS to paginate table
// $(document).ready(function() {
//     $('.myTable').DataTable();
// } );

// Show rows that meet filters
function myFilter(){
  var input1, input2, input3, tr, td1, td2, td3, i;
  input1 = $("#myDate").val();
  input2 = $("#myResto").val().toUpperCase();
  input3 = $("#myNum").val();
  tr = $(".reservation-entry");
  for (i = 0; i < tr.length; i++) {
    td1 = tr[i].getElementsByTagName("td")[0];
    td2 = tr[i].getElementsByTagName("td")[1];
    td3 = tr[i].getElementsByTagName("td")[2];
    if ((td1.innerHTML.indexOf(input1) > -1) 
      && (td2.innerHTML.toUpperCase().indexOf(input2) > -1)
      && (td3.innerHTML.indexOf(input3) > -1)) {
        tr[i].style.display = "";
      } else {
        tr[i].style.display = "none";
    }
  }
}

// Toggle filter fields on and off
$(document).ready(function(){
    $(".glyphicon-filter").click(function(){
        $(".search-fields").toggle();
    });
});

// Event listener to reset filter fields, currently not functioning
$("#reset" ).click(function() {
  $("#myDate").val("");
  $("#myResto").val("");
  $("#myNum").val("");
  var tr = $(".reservation-entry");
  for (i = 0; i < tr.length; i++) {
    tr[i].style.display = "";
  }
});

// Global variables for Google Maps
var map;
var sanFrancisco = {lat: 37.7749, lng: -122.431297}; 
var markersArray = [];

// Create map upon page load
function initMap() {
  map = new google.maps.Map(document.getElementById('homepage-map'), {
    center: sanFrancisco,
    zoom: 13
  });
}

// Add markers on map
function addMarker(lat, lng, content, map) {
    var marker = new google.maps.Marker({
      position: {lat: lat, lng: lng},
      map: map
    });

    var infowindow = new google.maps.InfoWindow({
      content: content
    });

    // Add marker to Array to be used by clearOverlays
    markersArray.push(marker);

    // Show infowinder on hover over
    marker.addListener('mouseover', function() {
    infowindow.open(map, this);
    });

    // Hide infowindow on mouse out
    marker.addListener('mouseout', function() {
        infowindow.close();
    });
}

// Clear all markers on map
function clearOverlays() {
  for (var i = 0; i < markersArray.length; i++ ) {
    markersArray[i].setMap(null);
  }
  markersArray.length = 0;
}


// Create markers based on AJAX response
function createMarkers(results) {
  var marker_details = JSON.parse(results);
  for (var i = 1; i < ((Object.keys(marker_details).length) + 1); i++) { 
      addMarker(marker_details[i].lat, marker_details[i].lng, marker_details[i].name, map);
    }
}

// Get JSON file of resto markers based on selected filters
function getRestoMarkers() {
  var queryInputs = {
    "date": $("#myDate").val(),
    "resto": $("#myResto").val(),
    "people": $("#myNum").val(),
  };
  $.post('/resto_markers', queryInputs, createMarkers);
  console.log(queryInputs);
  console.log('Finished sending AJAX');
}

// Event listeners for buttons above map
$('#populate_map').click(getRestoMarkers);
$('#reset_map').click(clearOverlays);


</script>

<script src="https://maps.googleapis.com/maps/api/js?key={{ gkey }}&callback=initMap"
async defer></script>

{% endblock %}



